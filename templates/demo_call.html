<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Agent</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #0066FF;
            --primary-hover: #0052CC;
            --bg: #0B1120;
            --surface: #111827;
            --surface-2: #1F2937;
            --border: #374151;
            --text: #F9FAFB;
            --text-secondary: #9CA3AF;
            --text-muted: #6B7280;
            --success: #10B981;
            --danger: #EF4444;
            --warning: #F59E0B;
        }

        html,
        body {
            height: 100%;
            background: var(--bg);
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            color: var(--text);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
        }

        .app {
            width: 100%;
            max-width: 480px;
            background: var(--surface);
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        @media (min-width: 520px) {
            body {
                padding: 24px;
            }

            .app {
                height: auto;
                min-height: 600px;
                max-height: 85vh;
                border-radius: 16px;
                border: 1px solid var(--border);
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            }
        }

        .header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .brand-icon {
            width: 32px;
            height: 32px;
            background: var(--primary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .brand-icon svg {
            width: 18px;
            height: 18px;
            fill: #fff;
        }

        .brand-text {
            font-size: 15px;
            font-weight: 600;
        }

        .btn-logout {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .btn-logout:hover {
            background: var(--surface-2);
            color: var(--text);
        }

        .status-bar {
            padding: 10px 20px;
            background: var(--bg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 12px;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--text-muted);
        }

        .status-dot.connected {
            background: var(--success);
        }

        .status-dot.calling {
            background: var(--warning);
            animation: blink 1s infinite;
        }

        .status-dot.ended {
            background: var(--danger);
        }

        @keyframes blink {
            50% {
                opacity: 0.4;
            }
        }

        .status-text {
            color: var(--text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .duration {
            color: var(--text-muted);
            font-variant-numeric: tabular-nums;
        }

        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .form-section {
            padding: 20px;
        }

        .input-group {
            margin-bottom: 16px;
        }

        .input-group:last-child {
            margin-bottom: 0;
        }

        .input-label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .input-field {
            width: 100%;
            padding: 10px 14px;
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 14px;
            outline: none;
            transition: border-color 0.15s;
        }

        .input-field::placeholder {
            color: var(--text-muted);
        }

        .input-field:focus {
            border-color: var(--primary);
        }

        .transcript-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            margin: 0 20px 20px;
            background: var(--bg);
            border-radius: 8px;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .transcript-header {
            padding: 10px 14px;
            border-bottom: 1px solid var(--border);
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .live-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--success);
            animation: blink 1.5s infinite;
            display: none;
        }

        .live-dot.active {
            display: block;
        }

        .transcript-list {
            flex: 1;
            overflow-y: auto;
            padding: 14px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .transcript-list::-webkit-scrollbar {
            width: 4px;
        }

        .transcript-list::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 2px;
        }

        .msg {
            max-width: 80%;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 13px;
            line-height: 1.5;
        }

        .msg-user {
            background: var(--primary);
            align-self: flex-end;
            border-bottom-right-radius: 2px;
        }

        .msg-agent {
            background: var(--surface-2);
            align-self: flex-start;
            border-bottom-left-radius: 2px;
        }

        .msg-system {
            align-self: center;
            background: transparent;
            color: var(--text-muted);
            font-size: 11px;
            padding: 4px 12px;
            border: 1px solid var(--border);
            border-radius: 20px;
        }

        .msg-time {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .msg-user .msg-time {
            color: rgba(255, 255, 255, 0.6);
            text-align: right;
        }

        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            gap: 8px;
        }

        .empty-icon {
            width: 40px;
            height: 40px;
            opacity: 0.5;
        }

        .empty-text {
            font-size: 13px;
        }

        .footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 10px;
        }

        .btn {
            flex: 1;
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.15s;
        }

        .btn-primary {
            background: var(--primary);
            color: #fff;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-hover);
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover:not(:disabled) {
            background: rgba(239, 68, 68, 0.2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn svg {
            width: 16px;
            height: 16px;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>

<body>
    <div class="app">
        <div class="header">
            <div class="brand">
                <div class="brand-icon">
                    <svg viewBox="0 0 24 24">
                        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" />
                    </svg>
                </div>
                <span class="brand-text">Voice Agent</span>
            </div>
            <button id="btn-logout" class="btn-logout {% if view != 'call' %}hidden{% endif %}">Logout</button>
        </div>

        <div class="status-bar {% if view != 'call' %}hidden{% endif %}" id="status-bar">
            <div class="status">
                <div class="status-dot" id="status-dot"></div>
                <span class="status-text" id="status-text">Ready</span>
            </div>
            <span class="duration" id="duration"></span>
        </div>

        <div class="main">
            <div id="login-view" class="{% if view == 'call' %}hidden{% endif %}"
                style="flex: 1; display: flex; align-items: center; justify-content: center; padding: 20px;">
                <div style="width: 100%; max-width: 320px; text-align: center;">
                    <div
                        style="width: 56px; height: 56px; background: var(--primary); border-radius: 14px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                        <svg width="28" height="28" fill="#fff" viewBox="0 0 24 24">
                            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" />
                        </svg>
                    </div>
                    <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 6px; color: var(--text);">Welcome back
                    </h2>
                    <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 28px;">Sign in to access Voice
                        Agent</p>
                    <div class="input-group" style="margin-bottom: 14px; text-align: left;">
                        <label class="input-label">Email</label>
                        <input type="email" id="login-email" class="input-field" placeholder="Enter email">
                    </div>
                    <div class="input-group" style="margin-bottom: 20px; text-align: left;">
                        <label class="input-label">Password</label>
                        <input type="password" id="login-password" class="input-field" placeholder="Enter password">
                    </div>
                    <button id="btn-login-main" class="btn btn-primary" style="width: 100%;">
                        Sign In
                    </button>
                </div>
            </div>

            <div id="call-view" class="{% if view != 'call' %}hidden{% endif %}"
                style="display: flex; flex-direction: column; flex: 1; overflow: hidden;">
                <div class="form-section" id="call-form">
                    <div class="input-group">
                        <label class="input-label">Phone Number</label>
                        <input type="tel" id="phone-number" class="input-field" placeholder="+1 234 567 8900">
                    </div>
                </div>
                <div class="transcript-container">
                    <div class="transcript-header">
                        <div class="live-dot" id="live-dot"></div>
                        <span>Transcript</span>
                    </div>
                    <div class="transcript-list" id="transcript-list">
                        <div class="empty-state" id="empty-state">
                            <svg class="empty-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                    d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                            </svg>
                            <span class="empty-text">No active call</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer {% if view != 'call' %}hidden{% endif %}" id="footer">
            <button id="btn-login" class="btn btn-primary hidden">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
                </svg>
                Sign In
            </button>
            <button id="btn-call" class="btn btn-primary {% if view != 'call' %}hidden{% endif %}">
                <svg fill="currentColor" viewBox="0 0 24 24">
                    <path
                        d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z" />
                </svg>
                Call
            </button>
            <button id="btn-hangup" class="btn btn-danger hidden" disabled>
                <svg fill="currentColor" viewBox="0 0 24 24">
                    <path
                        d="M12 9c-1.6 0-3.15.25-4.6.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.12-2.66 1.85-.18.18-.43.28-.7.28-.28 0-.53-.11-.71-.29L.29 13.08c-.18-.17-.29-.42-.29-.7 0-.28.11-.53.29-.71C3.34 8.78 7.46 7 12 7s8.66 1.78 11.71 4.67c.18.18.29.43.29.71 0 .28-.11.53-.29.71l-2.48 2.48c-.18.18-.43.29-.71.29-.27 0-.52-.11-.7-.28-.79-.74-1.69-1.36-2.67-1.85-.33-.16-.56-.5-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z" />
                </svg>
                End
            </button>
        </div>
    </div>

    <script>
        let callSid = null, ws = null, startTime = null, timer = null;
        const $ = id => document.getElementById(id);
        const statusDot = $('status-dot'), statusText = $('status-text'), duration = $('duration');
        const list = $('transcript-list'), empty = $('empty-state'), liveDot = $('live-dot');
        const btnLogin = $('btn-login'), btnLoginMain = $('btn-login-main'), btnCall = $('btn-call'), btnHangup = $('btn-hangup'), btnLogout = $('btn-logout');
        const loginView = $('login-view'), callView = $('call-view'), callForm = $('call-form');

        const fmt = s => `${String(Math.floor(s / 60)).padStart(2, '0')}:${String(s % 60).padStart(2, '0')}`;
        const time = () => new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

        function setStatus(s, t) {
            statusDot.className = 'status-dot ' + s;
            statusText.textContent = t;
            liveDot.classList.toggle('active', s === 'connected');
        }

        function addMsg(type, text) {
            if (empty) empty.style.display = 'none';
            const d = document.createElement('div');
            d.className = 'msg msg-' + type;
            if (type === 'system') d.textContent = text;
            else d.innerHTML = text + '<div class="msg-time">' + (type === 'user' ? 'You' : 'Agent') + ' â€¢ ' + time() + '</div>';
            list.appendChild(d);
            list.scrollTop = list.scrollHeight;
        }

        function startTimer() {
            startTime = Date.now();
            timer = setInterval(() => { duration.textContent = fmt(Math.floor((Date.now() - startTime) / 1000)); }, 1000);
        }

        function stopTimer() { if (timer) { clearInterval(timer); timer = null; } }

        function endCall() {
            callSid = null;
            btnCall.disabled = false;
            btnCall.classList.remove('hidden');
            btnHangup.classList.add('hidden');
            callForm.style.display = 'block';
            stopTimer();
            if (ws) { ws.close(); ws = null; }
        }

        function connectWs(sid) {
            const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${proto}//${location.host}/ws/transcript/${sid}`);
            ws.onmessage = e => {
                const d = JSON.parse(e.data);
                if (d.type === 'user') addMsg('user', d.text);
                else if (d.type === 'agent') addMsg('agent', d.text);
                else if (d.type === 'status') {
                    const s = (d.status || d.text || '').toLowerCase();
                    if (s === 'connected') { setStatus('connected', 'Connected'); startTimer(); }
                    else if (['ringing', 'initiated', 'in-progress'].includes(s)) addMsg('system', s.charAt(0).toUpperCase() + s.slice(1).replace('-', ' '));
                    else if (['busy', 'failed', 'no-answer', 'canceled', 'completed', 'disconnected'].includes(s)) {
                        const txt = s === 'no-answer' ? 'No Answer' : s.charAt(0).toUpperCase() + s.slice(1);
                        setStatus('ended', txt); addMsg('system', txt); stopTimer(); endCall();
                    } else addMsg('system', d.text || d.status);
                }
            };
        }

        btnLogin.onclick = async () => {
            btnLogin.disabled = true;
            const fd = new FormData();
            fd.append('email', $('login-email').value || 'demo@test.com');
            fd.append('password', $('login-password').value || 'demo123');
            try {
                const r = await fetch('/api/login', { method: 'POST', body: fd });
                if (r.ok) {
                    loginView.classList.add('hidden');
                    callView.classList.remove('hidden');
                    if (btnLogin) btnLogin.classList.add('hidden');
                    btnCall.classList.remove('hidden');
                    btnLogout.classList.remove('hidden');
                    $('status-bar').classList.remove('hidden');
                    $('footer').classList.remove('hidden');
                } else alert((await r.json()).detail || 'Login failed');
            } catch (e) { alert(e.message); }
            if (btnLogin) btnLogin.disabled = false;
            if (btnLoginMain) btnLoginMain.disabled = false;
        };

        if (btnLoginMain) btnLoginMain.onclick = btnLogin.onclick;

        btnCall.onclick = async () => {
            const phone = $('phone-number').value;
            if (!phone) return alert('Enter a phone number');
            btnCall.disabled = true;
            setStatus('calling', 'Calling');
            list.querySelectorAll('.msg').forEach(m => m.remove());
            if (empty) empty.style.display = 'flex';
            callForm.style.display = 'none';
            duration.textContent = '';
            try {
                const r = await fetch('/api/make-call', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ phone_number: phone }) });
                const d = await r.json();
                if (r.ok && d.call_sid) {
                    callSid = d.call_sid;
                    btnCall.classList.add('hidden');
                    btnHangup.classList.remove('hidden');
                    btnHangup.disabled = false;
                    addMsg('system', 'Calling ' + d.phone_number);
                    connectWs(d.call_sid);
                } else { alert(d.detail || 'Call failed'); btnCall.disabled = false; callForm.style.display = 'block'; setStatus('', 'Ready'); }
            } catch (e) { alert(e.message); btnCall.disabled = false; callForm.style.display = 'block'; setStatus('', 'Ready'); }
        };

        btnHangup.onclick = async () => {
            if (!callSid) return;
            btnHangup.disabled = true;
            try { await fetch('/api/hangup', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ call_sid: callSid }) }); } catch (e) { }
            setStatus('ended', 'Ended'); addMsg('system', 'Call ended'); endCall();
        };

        btnLogout.onclick = async () => {
            try { await fetch('/api/logout', { method: 'POST' }); } catch (e) { }
            location.reload();
        };

        document.querySelectorAll('.input-field').forEach(i => i.addEventListener('keypress', e => { if (e.key === 'Enter') { loginView.classList.contains('hidden') ? btnCall.click() : btnLogin.click(); } }));
    </script>
</body>

</html>